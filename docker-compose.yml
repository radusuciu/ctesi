version: '3.6'

services:
    ctesi:
        build: .
        environment:
            DEBUG: 'true'
            FLASK_DEBUG: 1
            FLASK_ENV: 'development'
            LC_ALL: 'C.UTF-8'
            LANG: 'C.UTF-8'
            FLASK_APP: 'ctesi/__init__.py'
        volumes:
            - .:/home/ctesi/ctesi
            - ../cimage-minimal:/home/ctesi/cimage-minimal
            - data:/data
            - finished_mirror:/finished
        tty: true
        stdin_open: true
    flask-readw:
        image: radusuciu/flask-readw
        environment:
            DEBUG: 'true'
            FLASK_DEBUG: 1
            FLASK_ENV: 'development'
            LC_ALL: 'C.UTF-8'
            LANG: 'C.UTF-8'
            FLASK_APP: 'flask_readw/__init__.py'
        volumes:
            - ../flask-readw:/app/flask_readw
            - data:/raw_vault
    rabbitmq:
        image: rabbitmq
        hostname: rabbitmq
        tty: true
        stdin_open: true
    redis:
        image: redis
        hostname: redis
    nginx:
        image: nginx
        volumes:
            - ./config/nginx.conf:/etc/nginx/ctesi.conf
            - ./ctesi/static:/usr/share/nginx/html/static
        ports:
            - '80:80'
        environment:
            NGINX_HOST: 'localhost'
        command: /bin/bash -c "envsubst '$$NGINX_HOST' < /etc/nginx/ctesi.conf > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
volumes:
    data:
    finished_mirror:
        external:
            name: ctesi
